---
title: "Tidyverse I: tidy data"
output: 
  learnr::tutorial:
    progressive: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE, remove_for_md=TRUE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, fig.path = "img/")
library(learnr)
#gradethis::gradethis_setup()
tutorial_options(
  exercise.reveal_solution = FALSE
)
```

```{r data}
library(tidyverse)
library(sf)
results = read_csv('https://raw.githubusercontent.com/vanatteveldt/ccslearnr/master/data/dutch_elections_2023ps.csv')
demographics = read_csv('https://raw.githubusercontent.com/vanatteveldt/ccslearnr/master/data/dutch_demographics.csv')

results = results |> group_by(gm) |> mutate(votes=votes/sum(votes)) 

anti_immigration_parties = c("JA21", "PVV (Partij voor de Vrijheid)", "Forum voor Democratie", "Belang van Nederland (BVNL)")

r = results |> 
  mutate(party = case_when(party %in% anti_immigration_parties ~ "Anti-immigration",
                           T ~ party)) |>
  filter(party %in% c("BBB", "Anti-immigration")) |>
  group_by(gm, gemeente, party) |>
  summarize(votes=sum(votes)) 
```

```{r plot, exercise=T, exercise.setup='data'}
inner_join(r, demo) |> 
  ggplot(aes(x=log10(v57_density), y=votes, color=party, size=v01_pop)) + 
  geom_point(alpha=.5) + 
  xlab("Population density (log scale)") + ylab("Relative support for party") +
  theme(legend.position = "top", legend.title = element_blank()) + 
  scale_color_manual(values=c("BBB"="green", "Anti-immigration"="blue"))+  scale_size(guide="none") + 
  ggtitle("Support for BBB and anti-immigration parties per municipality",
          "(Dutch 2023 provincial elections; note: size of point relative to logged municipality population)")
```

## Plotting maps

### Shape files

To look at regional or national differences, it can be very insightful to plot variables on a map.
To do this, R needs to know the *shape* of the various regions (such as the municipalities used above).
We can download a cleaned up Dutch 'shapefile' from the tutorial repository:

```{r loadshapes}
if (!file.exists("sf_nl.rds")) {
  library(tidyverse)
  shapes = read_rds("https://github.com/vanatteveldt/ccslearnr/raw/master/data/sf_nl.rds")
  write_rds(shapes, "sf_nl.rds")
} else {
  shapes = read_rds("sf_nl.rds")
}
```


```{r datagis, exercise=TRUE}
library(tidyverse)
library(sf)
shapes = read_rds("https://github.com/vanatteveldt/ccslearnr/raw/master/data/sf_nl.rds")
shapes
```

Now, we can plot this map using a regular ggplot command, using the `geom_sg` geometrical object, 
which can directly use the `geom` column from the shapefile. 
We can also specify the fill color of regions, for example using the province column:

```{r plotshape, exercise=TRUE, exercise.setup='loadshapes'}
ggplot(shapes) + geom_sf(aes(geometry=geom, fill=provincie))
```

### Combining shapes and demographic information

In the example above, we used only the spatial information to plot a map of Dutch municipalities.
Of course, it becomes much more interesting (and relevant!) if we can plot sociologically relevant information.

For this end, we need to *join* the spatial and demographic information, and then we can use other columns from the combined data set to color the regions. For example, the code below plots the 

```{r}
demographics |> filter(gemeente == "Dijk en Waard")
demographics |> filter(gemeente == "Heerhugowaard")

colnames(demographics)
inner_join(shapes, demographics) |> filter(is.na(v43_nl))
inner_join(shapes, demographics) |> 
  ggplot() + 
  geom_sf(aes(geometry=geom, fill=v43_nl)) + 
  scale_fill_gradient(high="white", low="red", name='% Nederlandse\nafkomst')
```

```{r datagis2, exercise=T, exercise.setup='datagis'}
bbb = results |> filter(party == "BBB") 
inner_join(shapes, bbb) |> ggplot() + geom_sf(aes(geometry=geom, fill=votes)) +
  ggtitle("Support for BBB per municipality") +
  scale_fill_gradient(low="white", high="darkgreen")

```

```{r datagis3, exercise=T, exercise.setup='datagis'}
pvv = results |> filter(party == "PVV (Partij voor de Vrijheid)") 
inner_join(shapes, pvv) |> ggplot() + geom_sf(aes(geometry=geom, fill=votes)) +
  ggtitle("Support for PVV per municipality") +
  scale_fill_gradient(low="white", high="orange")
```
